CREATE DATABASE IF NOT EXISTS `mvcshop`

-----------------------------------------

CREATE TABLE IF NOT EXISTS `users`
(Id int PRIMARY KEY AUTO_INCREMENT,
 Name varchar(30) NOT NULL,
 Surname varchar(30) NOT NULL,
 `Email` varchar(50) NOT NULL,
 Password varchar(50) NOT NULL,
 Phone varchar(25) NOT NULL);
 
CREATE TABLE IF NOT EXISTS `products`
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `Name` varchar(50),
  `QuantityInStock` int,
  `Discription` varchar(500),
  `Price` float(10),
  `ProductImageId` int);

CREATE TABLE IF NOT EXISTS `category`
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `Name` varchar(255) NOT NULL,
  `Description` text NOT NULL,
  `Position` tinyint(4) NOT NULL,
  `Img` varchar(255) NOT NULL,
  `Url` varchar(255) NOT NULL);

CREATE TABLE IF NOT EXISTS `categoryproduct` 
 (`CategoryId` int NOT NULL,
  `ProductId` int NOT NULL);

CREATE TABLE IF NOT EXISTS `productimg` 
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `ProductId` int NOT NULL,
  `Position` tinyint(4) NOT NULL,
  `Url` varchar(255) NOT NULL);
  
CREATE TABLE IF NOT EXISTS `orders` 
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `CustomerId` int NOT NULL,
  `Sum` mediumint(9) NOT NULL,
  `ProductCount` tinyint(4) NOT NULL);

CREATE TABLE `orderDetails` 
 (`OrderId` int DEFAULT NULL,
  `ProductId` int DEFAULT NULL,
  `ProductPrice` int DEFAULT NULL,
  `Count` int DEFAULT NULL);

--------------------------------------------

ALTER TABLE `products`
ADD FOREIGN KEY (ProductImageId) REFERENCES `productimg`(Id);

ALTER TABLE `categoryproduct`
ADD FOREIGN KEY (CategoryId) REFERENCES `category`(Id);

ALTER TABLE `categoryproduct`
ADD FOREIGN KEY (ProductId) REFERENCES `products`(Id);

ALTER TABLE `productimg`
ADD FOREIGN KEY (ProductId) REFERENCES `products`(Id);

ALTER TABLE `orders`
ADD FOREIGN KEY (CustomerId) REFERENCES `users`(Id);

ALTER TABLE `orderDetails`
ADD FOREIGN KEY (OrderId) REFERENCES `orders`(Id);

ALTER TABLE `orderDetails`
ADD FOREIGN KEY (ProductId) REFERENCES `products`(Id);

--------------------------------------------

CREATE VIEW `vshop` (`UserId`,`Name`,`Surname`,`Patronym`,`Email`,`Password`,`Phone`,`Age`,`ProductId`,`ProductName`,`Quantity`,`Discription`,`Price`,`Category`,`ProductImg`,`OrderNumber`,`bUserId`,`bProductId`,`bPrice`,`bCount`,`bAmount`,`bDate`)
AS
SELECT `users`.`Id`,`users`.`Name`,`Surname`,`Patronym`,`Email`,`Password`,`Phone`,`Age`,
	   `products`.`Id`,`products`.`Name`,`QuantityInStock`,`Discription`,`products`.`Price`,`Category`,`ProductImage`,
       `busket`.`Id`,`UserId`,`ProductId`,`busket`.`Price`,`Count`,`Amount`,`Date`
FROM `users` INNER JOIN `busket` ON `users`.`Id` = `busket`.`UserId`
			 INNER JOIN `products` ON `products`.`Id` = `busket`.`ProductId`
GROUP BY `users`.`Id`,`products`.`Id`,`busket`.`Id`

