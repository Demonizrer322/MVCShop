CREATE DATABASE IF NOT EXISTS `mvcshop`

-----------------------------------------

CREATE TABLE IF NOT EXISTS `users`
(Id int PRIMARY KEY AUTO_INCREMENT,
 Name varchar(30) NOT NULL,
 Surname varchar(30) NOT NULL,
 `Email` varchar(50) NOT NULL,
 Password varchar(50) NOT NULL,
 Phone varchar(25) NOT NULL);
 
CREATE TABLE IF NOT EXISTS `products`
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `Name` varchar(50),
  `QuantityInStock` int,
  `Description` varchar(500),
  `Price` float(10),
  `ProductImageId` int);

CREATE TABLE IF NOT EXISTS `category`
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `Name` varchar(255) NOT NULL,
  `Description` text NOT NULL,
  `Position` tinyint(4) NOT NULL);

CREATE TABLE IF NOT EXISTS `categoryproduct` 
 (`CategoryId` int NOT NULL,
  `ProductId` int NOT NULL);

CREATE TABLE IF NOT EXISTS `productimg` 
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `ProductId` int NOT NULL,
  `Position` tinyint(4) NOT NULL,
  `Url` varchar(255) NOT NULL);
  
CREATE TABLE IF NOT EXISTS `orders` 
 (`Id` int PRIMARY KEY AUTO_INCREMENT,
  `CustomerId` int NOT NULL,
  `Sum` mediumint(9) NOT NULL,
  `ProductCount` tinyint(4) NOT NULL);

CREATE TABLE `orderDetails` 
 (`OrderId` int DEFAULT NULL,
  `ProductId` int DEFAULT NULL,
  `ProductPrice` int DEFAULT NULL,
  `Count` int DEFAULT NULL);

--------------------------------------------

ALTER TABLE `products`
ADD FOREIGN KEY (ProductImageId) REFERENCES `productimg`(Id);

ALTER TABLE `categoryproduct`
ADD FOREIGN KEY (CategoryId) REFERENCES `category`(Id);

ALTER TABLE `categoryproduct`
ADD FOREIGN KEY (ProductId) REFERENCES `products`(Id);

ALTER TABLE `productimg`
ADD FOREIGN KEY (ProductId) REFERENCES `products`(Id);

ALTER TABLE `orders`
ADD FOREIGN KEY (CustomerId) REFERENCES `users`(Id);

ALTER TABLE `orderDetails`
ADD FOREIGN KEY (OrderId) REFERENCES `orders`(Id);

ALTER TABLE `orderDetails`
ADD FOREIGN KEY (ProductId) REFERENCES `products`(Id);

--------------------------------------------

CREATE VIEW `vproduct` (`ProductId`,`ProductName`,`Quantity`,`ProductDescription`,`ProductPrice`,`ProductImgId`,`CategoryId`,`CategoryName`,`CategoryDescription`,`CategoryPosition`,`MCategoryId`,`MProductId`,`ImgId`,`ImgProductId`,`ImgPosition`,`ImgUrl`)
AS
SELECT `products`.`Id`,`products`.`Name`,`QuantityInStock`,`products`.`Description`,`products`.`Price`,`products`.`ProductImageId`,
       `category`.`Id`,`category`.`Name`,`category`.`Description`,`category`.`Position`,
       `categoryproduct`.`CategoryId`,`categoryproduct`.`ProductId`,
       `productimg`.`Id`,`productimg`.`ProductId`,`productimg`.`Position`,`productimg`.`Url`
FROM `products` INNER JOIN `categoryproduct` ON `products`.`Id` = `categoryproduct`.`ProductId`
		INNER JOIN `category` ON `category`.`Id` = `categoryproduct`.`CategoryId`
		INNER JOIN `productimg` ON `productimg`.`ProductId` = `products`.`Id`
GROUP BY `products`.`Id`,`category`.`Id`,`productimg`.`Id`

